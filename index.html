<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Videos - Videos Personalizados con IA</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        
        .video-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
        }
        
        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.85) 0%, rgba(236, 72, 153, 0.85) 50%, rgba(59, 130, 246, 0.85) 100%);
            z-index: 1;
        }
        
        .video-content {
            position: relative;
            z-index: 2;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 1s ease-out;
        }

        .cart-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        
        .scroll-reviews {
            animation: scroll 60s linear infinite;
        }

        .scroll-reviews:hover {
            animation-play-state: paused;
        }

        .star-filled {
            color: #fbbf24;
        }
        
        .star-empty {
            color: #d1d5db;
        }

        .star-interactive {
            cursor: pointer;
            transition: all 0.2s;
        }

        .star-interactive:hover {
            transform: scale(1.2);
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ===== CONFIGURACI√ìN =====
        const SUPABASE_URL = 'https://vrhqvjsvqowsxioqusrw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZyaHF2anN2cW93c3hpb3F1c3J3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMjU3OTAsImV4cCI6MjA3ODYwMTc5MH0.FDSaJ-592b23kxeANFZ49vfP3skIBFv1hO5p9NSUfSE';
        const STRIPE_KEY = 'pk_test_51ST05MLwRYu46TgB8nY7XAlP9JjMTiL6sB8QwkGadNQW3JO2VNjfTUWm4IfG53oRdYYvDvzQRvaf4uBTBFb8Yyl000cjCYqRJR';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const stripe = Stripe(STRIPE_KEY);

        // ===== DATOS =====
        const personajes = [
            { 
                id: 1, 
                nombre: 'S√∫per H√©roe', 
                emoji: 'ü¶∏', 
                precio: 29.99, 
                descripcion: 'Videos de acci√≥n y aventuras heroicas llenas de emoci√≥n',
                videoDemo: 'Avatar_IV_Video.mp4',
                esNuevo: true,
                popularidad: 95
            },
            { 
                id: 2, 
                nombre: 'Princesa M√°gica', 
                emoji: 'üë∏', 
                precio: 34.99, 
                descripcion: 'Cuentos de hadas m√°gicos llenos de encanto y fantas√≠a',
                videoDemo: 'Avatar_IV_Video.mp4',
                esNuevo: false,
                popularidad: 98
            },
            { 
                id: 3, 
                nombre: 'Dinosaurio Aventurero', 
                emoji: 'ü¶ï', 
                precio: 24.99, 
                descripcion: 'Aventuras prehist√≥ricas emocionantes para los peque√±os exploradores',
                videoDemo: 'Avatar_IV_Video.mp4',
                esNuevo: true,
                popularidad: 87
            },
            { 
                id: 4, 
                nombre: 'Robot del Espacio', 
                emoji: 'ü§ñ', 
                precio: 29.99, 
                descripcion: 'Misiones espaciales incre√≠bles con tecnolog√≠a futurista',
                videoDemo: 'Avatar_IV_Video.mp4',
                esNuevo: false,
                popularidad: 92
            },
            { 
                id: 5, 
                nombre: 'Hada Encantada', 
                emoji: 'üßö', 
                precio: 32.99, 
                descripcion: 'Magia y fantas√≠a encantadora en un mundo de ensue√±o',
                videoDemo: 'Avatar_IV_Video.mp4',
                esNuevo: true,
                popularidad: 90
            },
            { 
                id: 6, 
                nombre: 'Pirata Alegre', 
                emoji: 'üè¥‚Äç‚ò†Ô∏è', 
                precio: 27.99, 
                descripcion: 'B√∫squeda de tesoros y aventuras en alta mar',
                videoDemo: 'Avatar_IV_Video.mp4',
                esNuevo: false,
                popularidad: 85
            }
        ];

        const reviewsEjemplo = [
            { id: 1, nombre: 'Mar√≠a Garc√≠a', personaje: 'Princesa M√°gica', calificacion: 5, comentario: '¬°Mi hija llor√≥ de emoci√≥n! El video es incre√≠ble, s√∫per personalizado. 100% recomendado.', fecha: '2025-11-10' },
            { id: 2, nombre: 'Carlos Rodr√≠guez', personaje: 'S√∫per H√©roe', calificacion: 5, comentario: 'Excelente calidad, lleg√≥ antes de tiempo. Mi hijo no para de verlo.', fecha: '2025-11-09' },
            { id: 3, nombre: 'Ana Mart√≠nez', personaje: 'Hada Encantada', calificacion: 5, comentario: 'Simplemente perfecto. La atenci√≥n al detalle es impresionante. ¬°Gracias!', fecha: '2025-11-08' },
            { id: 4, nombre: 'Luis Fern√°ndez', personaje: 'Robot del Espacio', calificacion: 4, comentario: 'Muy buen video, mi hijo qued√≥ fascinado. Entrega r√°pida.', fecha: '2025-11-07' },
            { id: 5, nombre: 'Patricia L√≥pez', personaje: 'Dinosaurio Aventurero', calificacion: 5, comentario: 'La mejor compra que he hecho. El video super√≥ todas mis expectativas.', fecha: '2025-11-06' },
            { id: 6, nombre: 'Roberto Silva', personaje: 'Pirata Alegre', calificacion: 5, comentario: '¬°Incre√≠ble! Mi sobrino lo adora. Definitivamente volver√© a comprar.', fecha: '2025-11-05' }
        ];

        const tiposVideo = [
            { id: 'cumpleanos', nombre: 'Cumplea√±os', precio: 0 },
            { id: 'mensaje', nombre: 'Mensaje Especial', precio: 5 },
            { id: 'aventura', nombre: 'Historia de Aventura', precio: 10 }
        ];

        const duraciones = [
            { id: 'corto', nombre: '1-2 minutos', precioExtra: 0 },
            { id: 'medio', nombre: '3-4 minutos', precioExtra: 15 },
            { id: 'largo', nombre: '5+ minutos', precioExtra: 25 }
        ];

        const velocidades = [
            { id: 'estandar', nombre: 'Est√°ndar (3-5 d√≠as)', horas: 120, precioExtra: 0 },
            { id: 'rapida', nombre: 'R√°pida (1-2 d√≠as)', horas: 48, precioExtra: 20 },
            { id: 'express', nombre: 'Express (24 horas)', horas: 24, precioExtra: 40 }
        ];

        // ===== COMPONENTES AUXILIARES =====
        function StarRating({ rating, interactive = false, onRate = null }) {
            return (
                <div className="flex items-center">
                    {[...Array(5)].map((_, i) => (
                        <span 
                            key={i} 
                            className={`text-xl ${i < rating ? 'star-filled' : 'star-empty'} ${interactive ? 'star-interactive' : ''}`}
                            onClick={() => interactive && onRate && onRate(i + 1)}
                        >
                            ‚òÖ
                        </span>
                    ))}
                </div>
            );
        }

        // ===== MODAL LOGIN/REGISTRO =====
        function LoginModal({ isOpen, onClose, onLoginSuccess }) {
            const [mode, setMode] = useState('login'); // 'login', 'register', 'forgot'
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [nombre, setNombre] = useState('');
            const [loading, setLoading] = useState(false);
            const [mensaje, setMensaje] = useState('');

            if (!isOpen) return null;

            const handleGoogleLogin = async () => {
                try {
                    const { error } = await supabase.auth.signInWithOAuth({
                        provider: 'google',
                        options: { redirectTo: window.location.origin }
                    });
                    if (error) throw error;
                } catch (error) {
                    setMensaje('Error: ' + error.message);
                }
            };

            const handleEmailLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setMensaje('');
                
                try {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email,
                        password
                    });
                    
                    if (error) throw error;
                    
                    setMensaje('¬°Inicio de sesi√≥n exitoso!');
                    setTimeout(() => {
                        onLoginSuccess();
                        onClose();
                    }, 1000);
                } catch (error) {
                    setMensaje('Error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                setLoading(true);
                setMensaje('');
                
                try {
                    const { data, error } = await supabase.auth.signUp({
                        email,
                        password,
                        options: {
                            data: {
                                full_name: nombre
                            }
                        }
                    });
                    
                    if (error) throw error;
                    
                    setMensaje('¬°Registro exitoso! Revisa tu email para confirmar tu cuenta.');
                    setTimeout(() => {
                        setMode('login');
                    }, 2000);
                } catch (error) {
                    setMensaje('Error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleForgotPassword = async (e) => {
                e.preventDefault();
                setLoading(true);
                setMensaje('');
                
                try {
                    const { error } = await supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: window.location.origin
                    });
                    
                    if (error) throw error;
                    
                    setMensaje('¬°Email enviado! Revisa tu bandeja de entrada para restablecer tu contrase√±a.');
                } catch (error) {
                    setMensaje('Error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="modal-backdrop" onClick={onClose}>
                    <div className="bg-white rounded-3xl p-8 max-w-md w-full mx-4 shadow-2xl" onClick={(e) => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                                {mode === 'login' ? 'Iniciar Sesi√≥n' : mode === 'register' ? 'Registrarse' : 'Recuperar Contrase√±a'}
                            </h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>

                        {/* Google Login */}
                        <button onClick={handleGoogleLogin}
                            className="w-full bg-white border-2 border-gray-300 text-gray-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-50 transition mb-6 flex items-center justify-center gap-3">
                            <svg className="w-6 h-6" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Continuar con Google
                        </button>

                        <div className="relative mb-6">
                            <div className="absolute inset-0 flex items-center">
                                <div className="w-full border-t border-gray-300"></div>
                            </div>
                            <div className="relative flex justify-center text-sm">
                                <span className="px-2 bg-white text-gray-500">O</span>
                            </div>
                        </div>

                        {/* Forms */}
                        {mode === 'login' && (
                            <form onSubmit={handleEmailLogin}>
                                <input type="email" value={email} onChange={(e) => setEmail(e.target.value)}
                                    placeholder="Email" required
                                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl mb-4 focus:border-purple-600 focus:outline-none" />
                                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)}
                                    placeholder="Contrase√±a" required
                                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl mb-4 focus:border-purple-600 focus:outline-none" />
                                <button type="submit" disabled={loading}
                                    className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-xl font-bold hover:shadow-lg transition disabled:opacity-50">
                                    {loading ? 'Iniciando...' : 'Iniciar Sesi√≥n'}
                                </button>
                                <div className="mt-4 text-center space-y-2">
                                    <button type="button" onClick={() => setMode('forgot')} className="text-purple-600 hover:underline text-sm">
                                        ¬øOlvidaste tu contrase√±a?
                                    </button>
                                    <p className="text-sm text-gray-600">
                                        ¬øNo tienes cuenta? <button type="button" onClick={() => setMode('register')} className="text-purple-600 hover:underline font-semibold">Reg√≠strate</button>
                                    </p>
                                </div>
                            </form>
                        )}

                        {mode === 'register' && (
                            <form onSubmit={handleRegister}>
                                <input type="text" value={nombre} onChange={(e) => setNombre(e.target.value)}
                                    placeholder="Nombre completo" required
                                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl mb-4 focus:border-purple-600 focus:outline-none" />
                                <input type="email" value={email} onChange={(e) => setEmail(e.target.value)}
                                    placeholder="Email" required
                                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl mb-4 focus:border-purple-600 focus:outline-none" />
                                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)}
                                    placeholder="Contrase√±a (m√≠nimo 6 caracteres)" required minLength="6"
                                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl mb-4 focus:border-purple-600 focus:outline-none" />
                                <button type="submit" disabled={loading}
                                    className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-xl font-bold hover:shadow-lg transition disabled:opacity-50">
                                    {loading ? 'Registrando...' : 'Crear Cuenta'}
                                </button>
                                <p className="mt-4 text-center text-sm text-gray-600">
                                    ¬øYa tienes cuenta? <button type="button" onClick={() => setMode('login')} className="text-purple-600 hover:underline font-semibold">Inicia sesi√≥n</button>
                                </p>
                            </form>
                        )}

                        {mode === 'forgot' && (
                            <form onSubmit={handleForgotPassword}>
                                <p className="text-gray-600 mb-4 text-sm">Te enviaremos un email con instrucciones para restablecer tu contrase√±a.</p>
                                <input type="email" value={email} onChange={(e) => setEmail(e.target.value)}
                                    placeholder="Email" required
                                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl mb-4 focus:border-purple-600 focus:outline-none" />
                                <button type="submit" disabled={loading}
                                    className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-xl font-bold hover:shadow-lg transition disabled:opacity-50">
                                    {loading ? 'Enviando...' : 'Enviar Email'}
                                </button>
                                <p className="mt-4 text-center text-sm text-gray-600">
                                    <button type="button" onClick={() => setMode('login')} className="text-purple-600 hover:underline font-semibold">Volver al inicio de sesi√≥n</button>
                                </p>
                            </form>
                        )}

                        {mensaje && (
                            <div className={`mt-4 p-4 rounded-xl ${mensaje.includes('Error') ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                                {mensaje}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // ===== MODAL REVIEW =====
        function ReviewModal({ isOpen, onClose, pedido, onReviewSubmit }) {
            const [calificacion, setCalificacion] = useState(5);
            const [comentario, setComentario] = useState('');
            const [loading, setLoading] = useState(false);

            if (!isOpen || !pedido) return null;

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);

                try {
                    // Aqu√≠ ir√≠a la llamada al API para guardar la review
                    // Por ahora simulamos
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    onReviewSubmit({
                        pedidoId: pedido.id,
                        calificacion,
                        comentario
                    });

                    alert('¬°Gracias por tu rese√±a! Se ha agregado un cup√≥n del 30% a tu cuenta. üéâ');
                    onClose();
                } catch (error) {
                    alert('Error al enviar rese√±a: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="modal-backdrop" onClick={onClose}>
                    <div className="bg-white rounded-3xl p-8 max-w-lg w-full mx-4 shadow-2xl" onClick={(e) => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                                Deja tu Rese√±a
                            </h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>

                        <div className="bg-purple-50 rounded-2xl p-4 mb-6">
                            <p className="text-center font-bold text-purple-600 mb-2">üéÅ ¬°Obt√©n 30% de descuento!</p>
                            <p className="text-center text-sm text-gray-600">Al dejar tu rese√±a, recibir√°s autom√°ticamente un cup√≥n del 30% para tu pr√≥xima compra</p>
                        </div>

                        <form onSubmit={handleSubmit}>
                            <div className="mb-6">
                                <h3 className="text-lg font-bold mb-3">{pedido.personaje_nombre}</h3>
                                <p className="text-gray-600 text-sm mb-4">"{pedido.mensaje_personalizado}"</p>
                            </div>

                            <div className="mb-6">
                                <label className="block text-lg font-bold mb-3">Calificaci√≥n</label>
                                <div className="flex justify-center">
                                    <StarRating rating={calificacion} interactive={true} onRate={setCalificacion} />
                                </div>
                            </div>

                            <div className="mb-6">
                                <label className="block text-lg font-bold mb-3">Comentario</label>
                                <textarea value={comentario} onChange={(e) => setComentario(e.target.value)}
                                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl resize-none focus:border-purple-600 focus:outline-none"
                                    rows="5" placeholder="Cu√©ntanos tu experiencia..." required
                                />
                            </div>

                            <button type="submit" disabled={loading}
                                className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl text-lg font-bold hover:shadow-lg transition disabled:opacity-50">
                                {loading ? 'Enviando...' : 'Enviar Rese√±a y Obtener Cup√≥n üéüÔ∏è'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // ===== COMPONENTE PRINCIPAL =====
        function App() {
            const [usuario, setUsuario] = useState(null);
            const [currentPage, setCurrentPage] = useState('home');
            const [selectedPersonaje, setSelectedPersonaje] = useState(null);
            const [carrito, setCarrito] = useState([]);
            const [misPedidos, setMisPedidos] = useState([]);
            const [misCupones, setMisCupones] = useState([]);
            const [cuponAplicado, setCuponAplicado] = useState(null);
            const [loading, setLoading] = useState(false);
            const [showLoginModal, setShowLoginModal] = useState(false);
            const [showReviewModal, setShowReviewModal] = useState(false);
            const [pedidoParaReview, setPedidoParaReview] = useState(null);

            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    if (session) {
                        setUsuario({
                            id: session.user.id,
                            nombre: session.user.user_metadata.full_name || session.user.email.split('@')[0],
                            email: session.user.email,
                            avatar: session.user.user_metadata.avatar_url
                        });
                    }
                });

                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                    if (session) {
                        setUsuario({
                            id: session.user.id,
                            nombre: session.user.user_metadata.full_name || session.user.email.split('@')[0],
                            email: session.user.email,
                            avatar: session.user.user_metadata.avatar_url
                        });
                    } else {
                        setUsuario(null);
                    }
                });

                return () => subscription.unsubscribe();
            }, []);

            useEffect(() => {
                if (usuario) {
                    cargarPedidos();
                    cargarCupones();
                }
            }, [usuario]);

            const cargarPedidos = async () => {
                if (!usuario?.id) return;
                try {
                    const response = await fetch(`/api/pedidos/listar?usuario_id=${usuario.id}`);
                    const data = await response.json();
                    if (data.success) setMisPedidos(data.pedidos);
                } catch (error) {
                    console.error('Error cargando pedidos:', error);
                }
            };

            const cargarCupones = async () => {
                if (!usuario?.id) return;
                try {
                    // Simular cupones - en producci√≥n vendr√≠a del backend
                    // const response = await fetch(`/api/cupones/listar?usuario_id=${usuario.id}`);
                    // const data = await response.json();
                    // if (data.success) setMisCupones(data.cupones);
                    setMisCupones([]); // Por ahora vac√≠o
                } catch (error) {
                    console.error('Error cargando cupones:', error);
                }
            };

            const handleLoginClick = () => {
                setShowLoginModal(true);
            };

            const handleLoginSuccess = () => {
                // El usuario se actualizar√° autom√°ticamente por el onAuthStateChange
            };

            const handleLogout = async () => {
                await supabase.auth.signOut();
                setUsuario(null);
                setCarrito([]);
                setMisCupones([]);
                setCuponAplicado(null);
                setCurrentPage('home');
            };

            const agregarAlCarrito = (item) => {
                setCarrito([...carrito, item]);
                setCurrentPage('carrito');
            };

            const eliminarDelCarrito = (index) => {
                setCarrito(carrito.filter((_, i) => i !== index));
            };

            const aplicarCupon = (codigoCupon) => {
                const cupon = misCupones.find(c => c.codigo === codigoCupon && !c.usado);
                if (cupon) {
                    setCuponAplicado(cupon);
                    return true;
                }
                return false;
            };

            const handleCheckout = async () => {
                if (!usuario) {
                    alert('Debes iniciar sesi√≥n para continuar');
                    setShowLoginModal(true);
                    return;
                }
                if (carrito.length === 0) {
                    alert('El carrito est√° vac√≠o');
                    return;
                }

                try {
                    setLoading(true);
                    const response = await fetch('/api/checkout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            carrito, 
                            usuario,
                            cupon: cuponAplicado 
                        })
                    });

                    const data = await response.json();
                    if (data.error) throw new Error(data.error);
                    window.location.href = data.url;
                } catch (error) {
                    alert('Error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const verPersonaje = (personaje) => {
                setSelectedPersonaje(personaje);
                setCurrentPage('personaje');
            };

            const abrirModalReview = (pedido) => {
                setPedidoParaReview(pedido);
                setShowReviewModal(true);
            };

            const handleReviewSubmit = async (reviewData) => {
                // Agregar cup√≥n del 30% autom√°ticamente
                const nuevoCupon = {
                    id: Date.now(),
                    codigo: `REVIEW30-${Math.random().toString(36).substr(2, 9).toUpperCase()}`,
                    descuento: 30,
                    tipo: 'porcentaje',
                    usado: false,
                    fechaCreacion: new Date().toISOString(),
                    fechaExpiracion: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString() // 90 d√≠as
                };

                setMisCupones([...misCupones, nuevoCupon]);

                // Actualizar pedido como calificado
                setMisPedidos(misPedidos.map(p => 
                    p.id === reviewData.pedidoId ? { ...p, calificado: true } : p
                ));
            };

            // ===== HEADER =====
            const Header = () => (
                <header className="bg-white shadow-sm sticky top-0 z-40">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="flex justify-between items-center h-20">
                            <div className="flex items-center cursor-pointer" onClick={() => setCurrentPage('home')}>
                                <img src="logo.png" alt="Magic Videos" className="h-16" />
                            </div>
                            <nav className="hidden md:flex space-x-8">
                                <button onClick={() => setCurrentPage('home')} 
                                    className="text-gray-700 hover:text-purple-600 font-medium transition">
                                    Inicio
                                </button>
                                {usuario && (
                                    <>
                                        <button onClick={() => setCurrentPage('dashboard')} 
                                            className="text-gray-700 hover:text-purple-600 font-medium transition">
                                            Mi Cuenta
                                        </button>
                                        <button onClick={() => setCurrentPage('misPedidos')} 
                                            className="text-gray-700 hover:text-purple-600 font-medium transition">
                                            Mis Pedidos
                                        </button>
                                    </>
                                )}
                            </nav>
                            <div className="flex items-center space-x-4">
                                <button onClick={() => setCurrentPage('carrito')} className="relative">
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                                    </svg>
                                    {carrito.length > 0 && <span className="cart-badge">{carrito.length}</span>}
                                </button>
                                {usuario ? (
                                    <div className="flex items-center space-x-3">
                                        {usuario.avatar && <img src={usuario.avatar} alt="Avatar" className="w-10 h-10 rounded-full border-2 border-purple-200" />}
                                        <div className="hidden md:block">
                                            <p className="text-sm font-semibold">{usuario.nombre}</p>
                                            <p className="text-xs text-gray-500">{usuario.email}</p>
                                        </div>
                                        <button onClick={handleLogout} 
                                            className="text-sm text-gray-500 hover:text-red-600 font-medium transition">
                                            Salir
                                        </button>
                                    </div>
                                ) : (
                                    <button onClick={handleLoginClick} 
                                        className="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transition font-semibold">
                                        Iniciar Sesi√≥n
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </header>
            );

            return (
                <div className="min-h-screen bg-gray-50">
                    <Header />
                    <main>
                        {currentPage === 'home' && <HomePage verPersonaje={verPersonaje} />}
                        {currentPage === 'personaje' && <PersonajePage personaje={selectedPersonaje} agregarAlCarrito={agregarAlCarrito} usuario={usuario} onLoginClick={handleLoginClick} />}
                        {currentPage === 'dashboard' && <DashboardPage usuario={usuario} pedidos={misPedidos} cupones={misCupones} setCurrentPage={setCurrentPage} />}
                        {currentPage === 'cupones' && <CuponesPage usuario={usuario} cupones={misCupones} />}
                        {currentPage === 'videosEntregados' && <VideosEntregadosPage usuario={usuario} pedidos={misPedidos} onDejarReview={abrirModalReview} />}
                        {currentPage === 'carrito' && <CarritoPage carrito={carrito} eliminarDelCarrito={eliminarDelCarrito} handleCheckout={handleCheckout} loading={loading} setCurrentPage={setCurrentPage} cupones={misCupones} cuponAplicado={cuponAplicado} aplicarCupon={aplicarCupon} />}
                        {currentPage === 'misPedidos' && <MisPedidosPage pedidos={misPedidos} usuario={usuario} />}
                    </main>

                    <LoginModal 
                        isOpen={showLoginModal} 
                        onClose={() => setShowLoginModal(false)}
                        onLoginSuccess={handleLoginSuccess}
                    />

                    <ReviewModal
                        isOpen={showReviewModal}
                        onClose={() => setShowReviewModal(false)}
                        pedido={pedidoParaReview}
                        onReviewSubmit={handleReviewSubmit}
                    />
                </div>
            );
        }

        // ===== HOME PAGE ===== 
        function HomePage({ verPersonaje }) {
            const personajesNuevos = personajes.filter(p => p.esNuevo);
            const personajesPopulares = [...personajes].sort((a, b) => b.popularidad - a.popularidad).slice(0, 3);

            return (
                <div>
                    {/* Hero */}
                    <section className="relative h-screen flex items-center justify-center overflow-hidden">
                        <video autoPlay loop muted playsInline className="video-background">
                            <source src="Avatar_IV_Video.mp4" type="video/mp4" />
                        </video>
                        <div className="video-overlay"></div>
                        <div className="video-content text-center px-4 fade-in">
                            <h1 className="text-5xl md:text-7xl font-bold text-white mb-6">
                                Videos M√°gicos Para<br />Momentos Especiales
                            </h1>
                            <p className="text-xl md:text-2xl text-white mb-8 max-w-2xl mx-auto">
                                Videos personalizados √∫nicos con tus personajes favoritos
                            </p>
                            <button onClick={() => window.scrollTo({ top: window.innerHeight, behavior: 'smooth' })} 
                                className="bg-white text-purple-600 px-8 py-4 rounded-full text-lg font-bold hover:scale-110 transform transition shadow-2xl">
                                Explorar Personajes ‚ú®
                            </button>
                            <div className="mt-12 flex justify-center space-x-8 text-white">
                                <div className="text-center">
                                    <div className="text-4xl font-bold">1000+</div>
                                    <div className="text-sm">Videos Creados</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-4xl font-bold">4.9/5</div>
                                    <div className="text-sm">Calificaci√≥n</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-4xl font-bold">99%</div>
                                    <div className="text-sm">Satisfacci√≥n</div>
                                </div>
                            </div>
                        </div>
                    </section>

                    {/* Carrusel de Reviews */}
                    <section className="py-12 bg-white overflow-hidden">
                        <div className="max-w-7xl mx-auto px-4 mb-8">
                            <h2 className="text-3xl font-bold text-center bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                                ‚≠ê Lo Que Dicen Nuestros Clientes
                            </h2>
                        </div>
                        <div className="flex overflow-hidden">
                            <div className="flex scroll-reviews gap-6 px-3">
                                {[...reviewsEjemplo, ...reviewsEjemplo].map((review, index) => (
                                    <div key={index} className="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl p-6 shadow-lg min-w-[350px] max-w-[350px]">
                                        <div className="flex items-center justify-between mb-4">
                                            <div>
                                                <p className="font-bold text-lg">{review.nombre}</p>
                                                <p className="text-sm text-gray-600">{review.personaje}</p>
                                            </div>
                                            <StarRating rating={review.calificacion} />
                                        </div>
                                        <p className="text-gray-700 italic">"{review.comentario}"</p>
                                        <p className="text-xs text-gray-500 mt-4">{review.fecha}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </section>

                    {/* Resto de secciones igual que antes... */}
                    <section className="py-16 px-4 bg-white">
                        <div className="max-w-7xl mx-auto">
                            <div className="flex justify-between items-center mb-10">
                                <h2 className="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                                    ‚ú® Personajes Nuevos
                                </h2>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                                {personajesNuevos.map(personaje => (
                                    <PersonajeCard key={personaje.id} personaje={personaje} onClick={() => verPersonaje(personaje)} />
                                ))}
                            </div>
                        </div>
                    </section>

                    <section className="py-16 px-4 bg-gradient-to-r from-purple-50 to-pink-50">
                        <div className="max-w-7xl mx-auto">
                            <div className="flex justify-between items-center mb-10">
                                <h2 className="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                                    üî• M√°s Comprados
                                </h2>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                                {personajesPopulares.map(personaje => (
                                    <PersonajeCard key={personaje.id} personaje={personaje} onClick={() => verPersonaje(personaje)} esPopular />
                                ))}
                            </div>
                        </div>
                    </section>

                    <section className="py-16 px-4 bg-white">
                        <div className="max-w-7xl mx-auto">
                            <h2 className="text-4xl font-bold text-center mb-12 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                                Todos los Personajes
                            </h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                                {personajes.map(personaje => (
                                    <PersonajeCard key={personaje.id} personaje={personaje} onClick={() => verPersonaje(personaje)} />
                                ))}
                            </div>
                        </div>
                    </section>

                    <section className="py-20 px-4 bg-gradient-to-r from-purple-600 to-pink-600">
                        <div className="max-w-7xl mx-auto">
                            <h2 className="text-4xl font-bold text-center mb-12 text-white">
                                ¬øC√≥mo Funciona?
                            </h2>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-8 text-white">
                                <div className="text-center">
                                    <div className="bg-white/20 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                                        <span className="text-4xl">1Ô∏è‚É£</span>
                                    </div>
                                    <h3 className="text-xl font-bold mb-3">Elige Personaje</h3>
                                    <p className="text-white/90">Selecciona tu favorito</p>
                                </div>
                                <div className="text-center">
                                    <div className="bg-white/20 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                                        <span className="text-4xl">2Ô∏è‚É£</span>
                                    </div>
                                    <h3 className="text-xl font-bold mb-3">Personaliza</h3>
                                    <p className="text-white/90">Escribe tu mensaje</p>
                                </div>
                                <div className="text-center">
                                    <div className="bg-white/20 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                                        <span className="text-4xl">3Ô∏è‚É£</span>
                                    </div>
                                    <h3 className="text-xl font-bold mb-3">Paga Seguro</h3>
                                    <p className="text-white/90">Con Stripe</p>
                                </div>
                                <div className="text-center">
                                    <div className="bg-white/20 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                                        <span className="text-4xl">4Ô∏è‚É£</span>
                                    </div>
                                    <h3 className="text-xl font-bold mb-3">Recibe Video</h3>
                                    <p className="text-white/90">En 24-72 horas</p>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            );
        }

        // Por limitaciones de espacio, incluyo solo las funciones principales actualizadas
        // El resto de componentes (PersonajeCard, PersonajePage, Dashboard, etc.) 
        // mantienen la misma estructura pero con las nuevas funcionalidades integradas

        function PersonajeCard({ personaje, onClick, esPopular }) {
            return (
                <div onClick={onClick}
                    className="bg-white rounded-3xl p-8 shadow-xl hover:shadow-2xl transition cursor-pointer transform hover:scale-105 relative">
                    {personaje.esNuevo && !esPopular && (
                        <span className="absolute top-4 right-4 bg-green-500 text-white px-3 py-1 rounded-full text-xs font-bold">
                            NUEVO
                        </span>
                    )}
                    {esPopular && (
                        <span className="absolute top-4 right-4 bg-red-500 text-white px-3 py-1 rounded-full text-xs font-bold">
                            üî• POPULAR
                        </span>
                    )}
                    <div className="text-7xl text-center mb-4">{personaje.emoji}</div>
                    <h3 className="text-2xl font-bold text-center mb-3">{personaje.nombre}</h3>
                    <p className="text-gray-600 text-center mb-6 text-sm">{personaje.descripcion}</p>
                    <div className="text-center">
                        <span className="text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                            ${personaje.precio}
                        </span>
                    </div>
                    <button className="w-full mt-6 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-xl font-bold hover:shadow-lg transition">
                        Ver Detalles ‚Üí
                    </button>
                </div>
            );
        }

        // ===== P√ÅGINA DE PERSONAJE =====
        function PersonajePage({ personaje, agregarAlCarrito, usuario, onLoginClick }) {
            const [tipoVideo, setTipoVideo] = useState(tiposVideo[0]);
            const [duracion, setDuracion] = useState(duraciones[0]);
            const [velocidad, setVelocidad] = useState(velocidades[0]);
            const [mensaje, setMensaje] = useState('');

            if (!personaje) return null;

            const precioTotal = personaje.precio + tipoVideo.precio + duracion.precioExtra + velocidad.precioExtra;
            const reviewsPersonaje = reviewsEjemplo.filter(r => r.personaje === personaje.nombre);
            const promedioCalificacion = reviewsPersonaje.length > 0 
                ? (reviewsPersonaje.reduce((sum, r) => sum + r.calificacion, 0) / reviewsPersonaje.length).toFixed(1)
                : '5.0';

            const handleAgregar = () => {
                if (!usuario) {
                    alert('Debes iniciar sesi√≥n para agregar al carrito');
                    onLoginClick();
                    return;
                }
                if (!mensaje.trim()) {
                    alert('Por favor escribe un mensaje');
                    return;
                }
                agregarAlCarrito({
                    personaje,
                    tipoVideo,
                    duracion,
                    velocidadEntrega: velocidad,
                    mensaje,
                    precioBase: personaje.precio,
                    precioTotal
                });
            };

            return (
                <div className="max-w-7xl mx-auto px-4 py-12">
                    <div className="grid md:grid-cols-2 gap-12 mb-12">
                        <div>
                            <div className="bg-black rounded-3xl overflow-hidden shadow-2xl mb-6">
                                <video controls className="w-full">
                                    <source src={personaje.videoDemo} type="video/mp4" />
                                </video>
                            </div>
                            <div className="bg-white rounded-2xl p-6 shadow-lg">
                                <div className="flex items-center justify-between mb-4">
                                    <h1 className="text-4xl font-bold">{personaje.emoji} {personaje.nombre}</h1>
                                    <span className="text-3xl font-bold text-purple-600">${personaje.precio}</span>
                                </div>
                                <p className="text-gray-600 mb-6">{personaje.descripcion}</p>
                                <div className="flex items-center space-x-4">
                                    <StarRating rating={5} />
                                    <span className="text-gray-600">({promedioCalificacion}/5 - {reviewsPersonaje.length || 127} reviews)</span>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-3xl p-8 shadow-xl">
                            <h2 className="text-3xl font-bold mb-8">Personaliza Tu Video</h2>
                            
                            <div className="mb-8">
                                <h3 className="text-xl font-bold mb-4">Tipo de Video</h3>
                                <div className="grid grid-cols-3 gap-4">
                                    {tiposVideo.map(t => (
                                        <button key={t.id} onClick={() => setTipoVideo(t)}
                                            className={`p-4 rounded-xl border-2 transition ${
                                                tipoVideo.id === t.id ? 'border-purple-600 bg-purple-50' : 'border-gray-200 hover:border-purple-300'
                                            }`}>
                                            <p className="font-semibold text-sm">{t.nombre}</p>
                                            <p className="text-purple-600 font-bold text-sm">+${t.precio}</p>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="mb-8">
                                <h3 className="text-xl font-bold mb-4">Duraci√≥n</h3>
                                <div className="grid grid-cols-3 gap-4">
                                    {duraciones.map(d => (
                                        <button key={d.id} onClick={() => setDuracion(d)}
                                            className={`p-4 rounded-xl border-2 transition ${
                                                duracion.id === d.id ? 'border-purple-600 bg-purple-50' : 'border-gray-200'
                                            }`}>
                                            <p className="font-semibold text-sm">{d.nombre}</p>
                                            <p className="text-purple-600 font-bold">+${d.precioExtra}</p>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="mb-8">
                                <h3 className="text-xl font-bold mb-4">Velocidad de Entrega</h3>
                                <div className="space-y-3">
                                    {velocidades.map(v => (
                                        <button key={v.id} onClick={() => setVelocidad(v)}
                                            className={`w-full p-4 rounded-xl border-2 transition text-left ${
                                                velocidad.id === v.id ? 'border-purple-600 bg-purple-50' : 'border-gray-200'
                                            }`}>
                                            <div className="flex justify-between items-center">
                                                <span className="font-semibold">{v.nombre}</span>
                                                <span className="text-purple-600 font-bold">+${v.precioExtra}</span>
                                            </div>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="mb-8">
                                <h3 className="text-xl font-bold mb-4">Tu Mensaje Personalizado</h3>
                                <textarea value={mensaje} onChange={(e) => setMensaje(e.target.value)}
                                    className="w-full p-4 border-2 border-gray-200 rounded-xl resize-none focus:border-purple-600 focus:outline-none"
                                    rows="6" placeholder="Escribe aqu√≠ tu mensaje especial..."
                                />
                            </div>

                            <div className="border-t-2 pt-6">
                                <div className="flex justify-between items-center mb-6">
                                    <span className="text-gray-600 text-lg">Total:</span>
                                    <span className="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                                        ${precioTotal.toFixed(2)}
                                    </span>
                                </div>
                                <button onClick={handleAgregar}
                                    className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl text-xl font-bold hover:scale-105 transition shadow-xl">
                                    Agregar al Carrito üõí
                                </button>
                            </div>
                        </div>
                    </div>

                    {reviewsPersonaje.length > 0 && (
                        <div className="bg-white rounded-3xl p-8 shadow-xl">
                            <h2 className="text-3xl font-bold mb-8">Opiniones de {personaje.nombre}</h2>
                            <div className="grid md:grid-cols-2 gap-6">
                                {reviewsPersonaje.map(review => (
                                    <div key={review.id} className="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl p-6">
                                        <div className="flex items-center justify-between mb-4">
                                            <div>
                                                <p className="font-bold">{review.nombre}</p>
                                                <p className="text-sm text-gray-600">{review.fecha}</p>
                                            </div>
                                            <StarRating rating={review.calificacion} />
                                        </div>
                                        <p className="text-gray-700 italic">"{review.comentario}"</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ===== DASHBOARD =====
        function DashboardPage({ usuario, pedidos, cupones, setCurrentPage }) {
            if (!usuario) {
                return (
                    <div className="text-center py-20">
                        <p className="text-xl">Inicia sesi√≥n para ver tu dashboard</p>
                    </div>
                );
            }

            const pedidosCompletados = pedidos.filter(p => p.estado === 'completado').length;

            return (
                <div className="max-w-7xl mx-auto px-4 py-12">
                    <h1 className="text-4xl font-bold mb-8">Mi Cuenta</h1>
                    
                    <div className="grid md:grid-cols-3 gap-6 mb-12">
                        <div className="bg-gradient-to-r from-purple-600 to-pink-600 rounded-3xl p-8 text-white shadow-xl cursor-pointer hover:scale-105 transition"
                            onClick={() => setCurrentPage('misPedidos')}>
                            <div className="text-5xl mb-4">üì¶</div>
                            <h2 className="text-3xl font-bold mb-2">{pedidos.length}</h2>
                            <p className="text-white/80">Total de Pedidos</p>
                        </div>

                        <div className="bg-gradient-to-r from-blue-600 to-cyan-600 rounded-3xl p-8 text-white shadow-xl cursor-pointer hover:scale-105 transition"
                            onClick={() => setCurrentPage('videosEntregados')}>
                            <div className="text-5xl mb-4">üé¨</div>
                            <h2 className="text-3xl font-bold mb-2">{pedidosCompletados}</h2>
                            <p className="text-white/80">Videos Recibidos</p>
                        </div>

                        <div className="bg-gradient-to-r from-green-600 to-emerald-600 rounded-3xl p-8 text-white shadow-xl cursor-pointer hover:scale-105 transition"
                            onClick={() => setCurrentPage('cupones')}>
                            <div className="text-5xl mb-4">üéüÔ∏è</div>
                            <h2 className="text-3xl font-bold mb-2">{cupones.filter(c => !c.usado).length}</h2>
                            <p className="text-white/80">Cupones Disponibles</p>
                        </div>
                    </div>

                    <div className="bg-white rounded-3xl p-8 shadow-xl mb-8">
                        <h2 className="text-2xl font-bold mb-6">Informaci√≥n Personal</h2>
                        <div className="grid md:grid-cols-2 gap-6">
                            <div>
                                <p className="text-gray-600 mb-2">Nombre</p>
                                <p className="text-xl font-semibold">{usuario.nombre}</p>
                            </div>
                            <div>
                                <p className="text-gray-600 mb-2">Email</p>
                                <p className="text-xl font-semibold">{usuario.email}</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ===== CUPONES PAGE =====
        function CuponesPage({ usuario, cupones }) {
            if (!usuario) {
                return (
                    <div className="text-center py-20">
                        <p className="text-xl">Inicia sesi√≥n para ver tus cupones</p>
                    </div>
                );
            }

            const cuponesActivos = cupones.filter(c => !c.usado);

            if (cuponesActivos.length === 0) {
                return (
                    <div className="max-w-4xl mx-auto px-4 py-12">
                        <h1 className="text-4xl font-bold mb-8">Mis Cupones</h1>
                        <div className="bg-white rounded-3xl p-16 shadow-xl text-center">
                            <div className="text-8xl mb-6">üéüÔ∏è</div>
                            <h2 className="text-3xl font-bold mb-4">A√∫n no tienes cupones disponibles</h2>
                            <p className="text-gray-600 mb-8">¬°Deja una rese√±a en un video completado y obt√©n un 30% de descuento!</p>
                            <div className="bg-purple-50 rounded-2xl p-6 inline-block">
                                <p className="text-sm text-gray-600 mb-2">üí° ¬øC√≥mo obtener cupones?</p>
                                <ul className="text-left text-sm text-gray-700 space-y-2">
                                    <li>‚úÖ Recibe tu video</li>
                                    <li>‚úÖ Deja una rese√±a con estrellas</li>
                                    <li>‚úÖ Obt√©n autom√°ticamente 30% OFF</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-4xl mx-auto px-4 py-12">
                    <h1 className="text-4xl font-bold mb-8">Mis Cupones</h1>
                    <div className="grid gap-6">
                        {cuponesActivos.map(cupon => (
                            <div key={cupon.id} className="bg-gradient-to-r from-green-50 to-emerald-50 rounded-3xl p-8 shadow-xl border-2 border-green-200">
                                <div className="flex justify-between items-center">
                                    <div className="flex-1">
                                        <div className="flex items-center gap-3 mb-3">
                                            <span className="text-4xl">üéüÔ∏è</span>
                                            <div>
                                                <h3 className="text-2xl font-bold text-green-700">{cupon.descuento}% OFF</h3>
                                                <p className="text-sm text-gray-600">C√≥digo: <span className="font-mono font-bold">{cupon.codigo}</span></p>
                                            </div>
                                        </div>
                                        <p className="text-gray-600 text-sm">V√°lido hasta: {new Date(cupon.fechaExpiracion).toLocaleDateString()}</p>
                                    </div>
                                    <button 
                                        onClick={() => {
                                            navigator.clipboard.writeText(cupon.codigo);
                                            alert('¬°C√≥digo copiado al portapapeles!');
                                        }}
                                        className="bg-green-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-green-700 transition">
                                        Copiar C√≥digo
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // ===== VIDEOS ENTREGADOS PAGE =====
        function VideosEntregadosPage({ usuario, pedidos, onDejarReview }) {
            if (!usuario) {
                return (
                    <div className="text-center py-20">
                        <p className="text-xl">Inicia sesi√≥n para ver tus videos</p>
                    </div>
                );
            }

            const videosCompletados = pedidos.filter(p => p.estado === 'completado' && p.video_url);

            if (videosCompletados.length === 0) {
                return (
                    <div className="max-w-4xl mx-auto px-4 py-12">
                        <h1 className="text-4xl font-bold mb-8">Videos Entregados</h1>
                        <div className="bg-white rounded-3xl p-16 shadow-xl text-center">
                            <div className="text-8xl mb-6">üé¨</div>
                            <h2 className="text-3xl font-bold mb-4">A√∫n no tienes videos entregados</h2>
                            <p className="text-gray-600 mb-8">Tus videos completados aparecer√°n aqu√≠ una vez listos.</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-6xl mx-auto px-4 py-12">
                    <h1 className="text-4xl font-bold mb-8">Videos Entregados</h1>
                    <div className="grid md:grid-cols-2 gap-6">
                        {videosCompletados.map(pedido => (
                            <div key={pedido.id} className="bg-white rounded-3xl p-6 shadow-xl">
                                <h3 className="text-2xl font-bold mb-4">{pedido.personaje_nombre}</h3>
                                <p className="text-gray-600 mb-4">{pedido.mensaje_personalizado}</p>
                                <a href={pedido.video_url} target="_blank" rel="noopener noreferrer"
                                    className="block w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-xl text-center font-bold hover:scale-105 transition mb-4">
                                    Ver Video üé¨
                                </a>
                                {!pedido.calificado && (
                                    <button 
                                        onClick={() => onDejarReview(pedido)}
                                        className="w-full border-2 border-purple-600 text-purple-600 py-3 rounded-xl font-bold hover:bg-purple-50 transition">
                                        ‚≠ê Dejar Rese√±a (Obt√©n 30% OFF)
                                    </button>
                                )}
                                {pedido.calificado && (
                                    <div className="text-center py-3 bg-green-50 rounded-xl">
                                        <p className="text-green-700 font-semibold">‚úì Rese√±a enviada</p>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // ===== CARRITO =====
        function CarritoPage({ carrito, eliminarDelCarrito, handleCheckout, loading, setCurrentPage, cupones, cuponAplicado, aplicarCupon }) {
            const [codigoCupon, setCodigoCupon] = useState('');
            const [mensajeCupon, setMensajeCupon] = useState('');

            const subtotal = carrito.reduce((sum, item) => sum + item.precioTotal, 0);
            const descuento = cuponAplicado ? (subtotal * cuponAplicado.descuento / 100) : 0;
            const total = subtotal - descuento;

            const handleAplicarCupon = () => {
                if (!codigoCupon.trim()) {
                    setMensajeCupon('Por favor ingresa un c√≥digo');
                    return;
                }

                const exito = aplicarCupon(codigoCupon);
                if (exito) {
                    setMensajeCupon('¬°Cup√≥n aplicado correctamente!');
                    setCodigoCupon('');
                } else {
                    setMensajeCupon('Cup√≥n inv√°lido o ya usado');
                }
            };

            if (carrito.length === 0) {
                return (
                    <div className="text-center py-20">
                        <div className="text-8xl mb-6">üõí</div>
                        <h2 className="text-3xl font-bold mb-4">Tu carrito est√° vac√≠o</h2>
                        <button onClick={() => setCurrentPage('home')} 
                            className="mt-6 bg-gradient-to-r from-purple-600 to-pink-600 text-white px-8 py-4 rounded-full font-bold hover:scale-105 transition">
                            Ver Personajes
                        </button>
                    </div>
                );
            }

            return (
                <div className="max-w-5xl mx-auto px-4 py-12">
                    <h1 className="text-4xl font-bold mb-8">Tu Carrito</h1>
                    <div className="bg-white rounded-3xl p-8 shadow-xl">
                        {carrito.map((item, i) => (
                            <div key={i} className="border-b-2 pb-6 mb-6 last:border-0">
                                <div className="flex justify-between">
                                    <div className="flex-1">
                                        <div className="flex items-center gap-3 mb-3">
                                            <span className="text-4xl">{item.personaje.emoji}</span>
                                            <h3 className="text-2xl font-bold">{item.personaje.nombre}</h3>
                                        </div>
                                        <p className="text-gray-600 mb-2">‚Ä¢ Tipo: {item.tipoVideo.nombre}</p>
                                        <p className="text-gray-600 mb-2">‚Ä¢ Duraci√≥n: {item.duracion.nombre}</p>
                                        <p className="text-gray-600 mb-2">‚Ä¢ Entrega: {item.velocidadEntrega.nombre}</p>
                                        <p className="text-gray-500 italic mt-3">"{item.mensaje}"</p>
                                    </div>
                                    <div className="text-right ml-6">
                                        <p className="text-3xl font-bold text-purple-600 mb-3">${item.precioTotal.toFixed(2)}</p>
                                        <button onClick={() => eliminarDelCarrito(i)} 
                                            className="text-red-600 hover:text-red-800 font-semibold transition">
                                            Eliminar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ))}
                        
                        <div className="border-t-2 pt-8 space-y-6">
                            <div className="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-4">
                                <p className="text-sm font-semibold mb-3">üéüÔ∏è ¬øTienes un cup√≥n de descuento?</p>
                                <div className="flex gap-2">
                                    <input 
                                        type="text" 
                                        value={codigoCupon}
                                        onChange={(e) => setCodigoCupon(e.target.value.toUpperCase())}
                                        placeholder="C√≥digo de cup√≥n" 
                                        disabled={cuponAplicado}
                                        className="flex-1 px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-600 focus:outline-none disabled:bg-gray-100" />
                                    <button 
                                        onClick={handleAplicarCupon}
                                        disabled={cuponAplicado || cupones.length === 0}
                                        className="px-6 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-semibold hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                                        {cuponAplicado ? '‚úì Aplicado' : 'Aplicar'}
                                    </button>
                                </div>
                                {mensajeCupon && (
                                    <p className={`text-xs mt-2 ${mensajeCupon.includes('correctamente') ? 'text-green-600' : 'text-red-600'}`}>
                                        {mensajeCupon}
                                    </p>
                                )}
                                {cuponAplicado && (
                                    <div className="mt-3 p-3 bg-green-100 rounded-lg">
                                        <p className="text-sm font-semibold text-green-700">
                                            ‚úì Cup√≥n "{cuponAplicado.codigo}" aplicado - {cuponAplicado.descuento}% de descuento
                                        </p>
                                    </div>
                                )}
                                {cupones.length === 0 && (
                                    <p className="text-xs text-gray-500 mt-2">¬°Deja una rese√±a para obtener tu primer cup√≥n!</p>
                                )}
                            </div>

                            <div className="space-y-3">
                                <div className="flex justify-between text-lg">
                                    <span className="text-gray-600">Subtotal:</span>
                                    <span className="font-semibold">${subtotal.toFixed(2)}</span>
                                </div>
                                {cuponAplicado && (
                                    <div className="flex justify-between text-lg text-green-600">
                                        <span>Descuento ({cuponAplicado.descuento}%):</span>
                                        <span className="font-semibold">-${descuento.toFixed(2)}</span>
                                    </div>
                                )}
                                <div className="flex justify-between items-center pt-3 border-t-2">
                                    <div>
                                        <p className="text-gray-600 mb-2">Total:</p>
                                        <p className="text-5xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                                            ${total.toFixed(2)}
                                        </p>
                                    </div>
                                    <button onClick={handleCheckout} disabled={loading}
                                        className="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-10 py-5 rounded-full text-xl font-bold hover:scale-105 transition disabled:opacity-50 shadow-xl">
                                        {loading ? 'Procesando...' : 'Pagar con Stripe üí≥'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ===== MIS PEDIDOS =====
        function MisPedidosPage({ pedidos, usuario }) {
            if (!usuario) {
                return (
                    <div className="text-center py-20">
                        <p className="text-xl">Inicia sesi√≥n para ver tus pedidos</p>
                    </div>
                );
            }

            if (pedidos.length === 0) {
                return (
                    <div className="text-center py-20">
                        <div className="text-8xl mb-6">üì¶</div>
                        <h2 className="text-3xl font-bold mb-4">No tienes pedidos a√∫n</h2>
                    </div>
                );
            }

            return (
                <div className="max-w-6xl mx-auto px-4 py-12">
                    <h1 className="text-4xl font-bold mb-8">Mis Pedidos</h1>
                    <div className="space-y-6">
                        {pedidos.map(pedido => (
                            <div key={pedido.id} className="bg-white rounded-3xl p-8 shadow-xl">
                                <div className="flex justify-between mb-6">
                                    <div>
                                        <h3 className="text-2xl font-bold mb-2">{pedido.personaje_nombre}</h3>
                                        <p className="text-gray-600">{pedido.mensaje_personalizado}</p>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-3xl font-bold text-purple-600">${pedido.precio_total}</p>
                                        <span className={`inline-block px-4 py-2 rounded-full text-sm font-bold mt-2 ${
                                            pedido.estado === 'completado' ? 'bg-green-100 text-green-800' :
                                            pedido.estado === 'pagado' ? 'bg-blue-100 text-blue-800' :
                                            'bg-yellow-100 text-yellow-800'
                                        }`}>
                                            {pedido.estado.toUpperCase()}
                                        </span>
                                    </div>
                                </div>
                                
                                <div className="w-full bg-gray-200 rounded-full h-6 mb-2">
                                    <div className="bg-gradient-to-r from-purple-600 to-pink-600 h-6 rounded-full transition-all flex items-center justify-center text-white text-sm font-bold"
                                        style={{width: `${pedido.progreso}%`}}>
                                        {pedido.progreso}%
                                    </div>
                                </div>
                                
                                {pedido.video_url && (
                                    <div className="mt-6 pt-6 border-t-2">
                                        <a href={pedido.video_url} target="_blank" rel="noopener noreferrer"
                                            className="inline-block bg-gradient-to-r from-purple-600 to-pink-600 text-white px-8 py-4 rounded-full font-bold hover:scale-105 transition shadow-xl">
                                            Ver Mi Video üé¨
                                        </a>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
